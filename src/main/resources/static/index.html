<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APISIX Control Plane</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <h1>APISIX Control Plane</h1>
                    <p class="subtitle">Environment-Scoped API Gateway Management</p>
                </div>
                <div class="global-org-selector">
                    <label for="globalOrgSelector">Organization:</label>
                    <select id="globalOrgSelector" onchange="handleGlobalOrgChange()">
                        <option value="">Select Organization</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Notification Area -->
        <div id="notificationArea" class="notification-area"></div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('organizations', this)">Organizations</button>
            <button class="tab-button" onclick="showTab('environments', this)">Environments</button>
            <button class="tab-button" onclick="showTab('upstreams', this)">Upstreams</button>
            <button class="tab-button" onclick="showTab('services-overview', this)">Services Overview</button>
            <button class="tab-button" onclick="showTab('services', this)">Services</button>
            <button class="tab-button" onclick="showTab('developers', this)">Developers</button>
            <button class="tab-button" onclick="showTab('subscriptions', this)">API Subscriptions</button>
            <button class="tab-button" onclick="showTab('products', this)">API Products</button>
            <button class="tab-button" onclick="showTab('product-subscriptions', this)">Product Subscriptions</button>
            <button class="tab-button" onclick="showTab('deployment', this)">Deployment</button>
        </div>

        <!-- Organizations Tab -->
        <div id="organizations" class="tab-content active">
            <div class="section">
                <h2>Create Organization</h2>
                <form id="createOrgForm" class="form">
                    <input type="text" id="orgName" placeholder="Organization Name" required>
                    <input type="text" id="orgDescription" placeholder="Description">
                    <button type="submit">Create Organization</button>
                </form>
            </div>
            <div class="section">
                <h2>Organizations</h2>
                <button onclick="loadOrganizations()" class="refresh-btn">Refresh</button>
                <div id="orgsList" class="list"></div>
            </div>
        </div>

        <!-- Environments Tab -->
        <div id="environments" class="tab-content">
            <div class="section">
                <h2>Create Environment</h2>
                <form id="createEnvForm" class="form">
                    <input type="text" id="envName" placeholder="Environment Name (e.g., qa, prod)" required>
                    <input type="text" id="envDescription" placeholder="Description">
                    <input type="text" id="envApisixUrl" placeholder="APISIX Admin URL (e.g., http://localhost:9180)" required>
                    <label>
                        <input type="checkbox" id="envActive" checked>
                        Active
                    </label>
                    <button type="submit">Create Environment</button>
                </form>
            </div>
            <div class="section">
                <h2>Environments</h2>
                <button onclick="loadEnvironments()" class="refresh-btn">Refresh</button>
                <div id="envsList" class="list"></div>
            </div>
        </div>

        <!-- Upstreams Tab -->
        <div id="upstreams" class="tab-content">
            <div class="section">
                <h2>Create Upstream</h2>
                <p class="info-text">Upstreams are environment-specific and created immediately in APISIX</p>
                <form id="createUpstreamForm" class="form">
                    <select id="upstreamEnvId" required>
                        <option value="">Select Environment</option>
                    </select>
                    <input type="text" id="upstreamName" placeholder="Upstream Name (unique in environment)" required>
                    <textarea id="upstreamSpecification" placeholder='Upstream spec JSON, e.g., {"type":"roundrobin","scheme":"https","nodes":{"api.example.com:443":1},"pass_host":"node"}' rows="4" required></textarea>
                    <button type="submit">Create Upstream</button>
                </form>
            </div>
            <div class="section">
                <h2>Upstreams by Environment</h2>
                <select id="upstreamEnvFilter" onchange="loadUpstreams()">
                    <option value="">Select Environment</option>
                </select>
                <button onclick="loadUpstreams()" class="refresh-btn">Refresh</button>
                <div id="upstreamsList" class="list"></div>
            </div>
        </div>

        <!-- Services Overview Tab -->
        <div id="services-overview" class="tab-content">
            <div class="section">
                <h2>Services Overview</h2>
                <div class="filter-row">
                    <button onclick="loadServicesOverview()" class="refresh-btn">Refresh</button>
                </div>
                <div id="servicesOverviewList" class="list"></div>
                <div id="overviewPagination" class="pagination"></div>
            </div>
        </div>

        <!-- Services & Revisions Tab -->
        <div id="services" class="tab-content">
            <div class="section">
                <h2>Create Service</h2>
                <form id="createServiceForm" class="form">
                    <input type="text" id="serviceName" placeholder="Service Name" required>
                    <input type="text" id="serviceDisplayName" placeholder="Display Name">
                    <button type="submit">Create Service</button>
                </form>
            </div>

            <div class="section">
                <h2 id="revisionFormTitle">Create Revision</h2>
                <form id="createRevisionForm" class="form">
                    <input type="hidden" id="editingRevisionId" value="">
                    <select id="revisionServiceId" required>
                        <option value="">Select Service</option>
                    </select>
                    <h3>Service-Level APISIX Plugins (Optional)</h3>
                    <p class="info-text">Configure APISIX plugins for the entire service (applies to all routes)</p>
                    <textarea id="servicePlugins" placeholder='Enter JSON config, e.g., {"limit-count": {"count": 100, "time_window": 60}}' rows="4"></textarea>

                    <h3>Environment-Specific Upstreams</h3>
                    <p class="info-text">Select upstream for each environment (optional, can be set during deployment)</p>
                    <div id="environmentUpstreamsContainer"></div>

                    <h3>Routes</h3>
                    <div id="routesContainer"></div>
                    <button type="button" onclick="addRoute()">+ Add Route</button>

                    <div class="form-actions">
                        <div id="createButtons" class="button-group-row">
                            <div class="button-group">
                                <button type="submit">Create Revision</button>
                            </div>
                        </div>
                        <div id="editButtons" class="button-group-row" style="display: none;">
                            <div class="button-group">
                                <button type="button" onclick="updateRevision()">Update Revision</button>
                            </div>
                            <div class="button-group">
                                <button type="button" onclick="cancelEdit()" class="secondary-btn">Cancel</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="section">
                <h2>Services & Revisions</h2>
                <button onclick="loadServices()" class="refresh-btn">Refresh</button>
                <div id="servicesList" class="list"></div>
            </div>
        </div>

        <!-- Developers Tab -->
        <div id="developers" class="tab-content">
            <div class="section">
                <h2>Add Developer</h2>
                <form id="createDeveloperForm" class="form">
                    <input type="email" id="developerEmail" placeholder="Email" required>
                    <input type="text" id="developerName" placeholder="Name" required>
                    <button type="submit">Add Developer</button>
                </form>
            </div>
            <div class="section">
                <h2>Developers</h2>
                <button onclick="loadDevelopers()" class="refresh-btn">Refresh</button>
                <div id="developersList" class="list"></div>
            </div>
        </div>

        <!-- API Subscriptions Tab -->
        <div id="subscriptions" class="tab-content">
            <div class="section">
                <h2>Create Subscription</h2>
                <form id="createSubscriptionForm" class="form">
                    <select id="subDeveloperId" required>
                        <option value="">Select Developer</option>
                    </select>
                    <select id="subEnvId" required onchange="loadServicesForSubscription()">
                        <option value="">Select Environment</option>
                    </select>
                    <select id="subServiceId" required>
                        <option value="">Select Service</option>
                    </select>
                    <button type="submit">Subscribe</button>
                </form>
            </div>
            <div class="section">
                <h2>Subscriptions</h2>
                <div class="filter-row">
                    <select id="subFilterDeveloperId" onchange="loadSubscriptions()">
                        <option value="">All Developers</option>
                    </select>
                    <select id="subFilterEnvId" onchange="loadSubscriptions()">
                        <option value="">All Environments</option>
                    </select>
                    <button onclick="loadSubscriptions()" class="refresh-btn">Refresh</button>
                </div>
                <div id="subscriptionsList" class="list"></div>
            </div>
        </div>

        <!-- API Products Tab -->
        <div id="products" class="tab-content">
            <div class="section">
                <h2>Create Product</h2>
                <form id="createProductForm" class="form">
                    <input type="text" id="productName" placeholder="Product Name" required>
                    <input type="text" id="productDisplayName" placeholder="Display Name" required>
                    <textarea id="productDescription" placeholder="Description" rows="3"></textarea>
                    <label>Select Services for this product:</label>
                    <div id="productServicesSelection" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <p style="color: var(--text-secondary); font-style: italic;">Loading services...</p>
                    </div>

                    <h3>Consumer Group Plugins (Optional)</h3>
                    <p class="info-text">Configure APISIX plugins to be applied at consumer group level</p>
                    <textarea id="productPluginConfig" placeholder='Enter JSON config, e.g., {"limit-count": {"count": 100, "time_window": 60}}' rows="4"></textarea>

                    <button type="submit">Create Product</button>
                </form>
            </div>
            <div class="section">
                <h2>Products</h2>
                <button onclick="loadProducts()" class="refresh-btn">Refresh</button>
                <div id="productsList" class="list"></div>
            </div>
        </div>

        <!-- Product Subscriptions Tab -->
        <div id="product-subscriptions" class="tab-content">
            <div class="section">
                <h2>Create Product Subscription</h2>
                <form id="createProductSubscriptionForm" class="form">
                    <select id="prodSubDeveloperId" required>
                        <option value="">Select Developer</option>
                    </select>
                    <select id="prodSubEnvId" required>
                        <option value="">Select Environment</option>
                    </select>
                    <select id="prodSubProductId" required>
                        <option value="">Select Product</option>
                    </select>
                    <button type="submit">Subscribe to Product</button>
                </form>
            </div>
            <div class="section">
                <h2>Product Subscriptions</h2>
                <div class="filter-row">
                    <select id="prodSubFilterDeveloperId" onchange="loadProductSubscriptions()">
                        <option value="">All Developers</option>
                    </select>
                    <select id="prodSubFilterEnvId" onchange="loadProductSubscriptions()">
                        <option value="">All Environments</option>
                    </select>
                    <button onclick="loadProductSubscriptions()" class="refresh-btn">Refresh</button>
                </div>
                <div id="productSubscriptionsList" class="list"></div>
            </div>
        </div>

        <!-- Deployment Tab -->
        <div id="deployment" class="tab-content">
            <div class="section">
                <h2>Deploy / Undeploy Revision</h2>
                <form id="deploymentForm" class="form">
                    <select id="deployServiceId" required onchange="loadServiceRevisions()">
                        <option value="">Select Service</option>
                    </select>
                    <select id="deployRevisionId" required onchange="loadDeploymentData()">
                        <option value="">Select Revision</option>
                    </select>
                    <div id="deploymentEnvironments"></div>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
